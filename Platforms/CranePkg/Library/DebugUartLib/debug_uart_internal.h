/** @file
 *   Copyright (c) 2025-2026. Project Aloha Authors. All rights reserved.
 *   Copyright (c) 2025-2026. Kancy Joe. All rights reserved.
 *   SPDX-License-Identifier: MIT
 */

#include <Library/debug_uart.h>
#include <oskal/common.h>
#include <oskal/cr_assert.h>
#include <oskal/cr_debug.h>
#include <oskal/cr_interrupt.h>
#include <oskal/cr_status.h>
#include <oskal/cr_string.h>
#include <oskal/cr_types.h>
#include <oskal/cr_memory.h>
#include <oskal/cr_time.h>

#define DEBUG_UART_GENI_DMA_MODE_EN 0x258

#define DEBUG_UART_GENI_M_IRQ_CLR 0x618
#define DEBUG_UART_GENI_M_IRQ_CLR_M_TX_FIFO_WATERMARK_EN BIT(30)

#define DEBUG_UART_GENI_S_IRQ_CLR 0x648
#define DEBUG_UART_GENI_S_IRQ_CLEAR_RX_FIFO_LAST BIT(27)

#define DEBUG_UART_GENI_M_IRQ_STATUS 0x610
#define DEBUG_UART_GENI_S_IRQ_STATUS 0x640

#define DEBUG_UART_GENI_M_CMD_DONE_EN BIT(0)
#define DEBUG_UART_GENI_M_ILLEGEAL_CMD_EN BIT(2)
#define DEBUG_UART_GENI_S_RX_FIFO_WR_ERR_EN BIT(25)

#define DEBUG_UART_GENI_RX_FIFO_STATUS 0x804
#define DEBUG_UART_GENI_RX_FIFO_STATUS_FIFO_WC_MSK GEN_MSK(24, 0)
#define DEBUG_UART_GENI_RX_FIFO_STATUS_LAST_BYTE_VALID_MSK GEN_MSK(30, 28)
#define DEBUG_UART_GENI_RX_FIFO_STATUS_RX_LAST_MSK BIT(31)

#define DEBUG_UART_GENI_TX_FIFO_STATUS 0x800
#define DEBUG_UART_GENI_TX_FIFO_STATUS_FIFO_WC_MSK GEN_MSK(27, 0)

#define DEBUG_UART_GENI_TX_FIFOn 0x700

#define DEBUG_UART_GENI_RX_FIFOn 0x780
#define DEBUG_UART_GENI_RX_WATERMARK 0x810
#define DEBUG_UART_GENI_RX_RFR_WATERMARK 0x814

#define DEBUG_UART_GENI_TX_WATERMARK 0x80C

#define DEBUG_UART_GENI_SE_HW_PARAM_0 0xE24
#define DEBUG_UART_GENI_SE_HW_PARAM_0_TX_FIFO_DEPTH_MSK GEN_MSK(21, 16)

#define DEBUG_UART_GENI_SE_HW_PARAM_1 0xE28
#define DEBUG_UART_GENI_SE_HW_PARAM_1_RX_FIFO_DEPTH_MSK GEN_MSK(21, 16)

#define DEBUG_UART_GENI_M_IRQ_EN 0x614
#define DEBUG_UART_GENI_M_IRQ_EN_M_CMD_DONE_EN BIT(0)
#define DEBUG_UART_GENI_M_IRQ_EN_M_CMD_OVERRUN_EN BIT(1)
#define DEBUG_UART_GENI_M_IRQ_EN_M_ILLEGAL_CMD_EN BIT(2)
#define DEBUG_UART_GENI_M_IRQ_EN_M_CMD_FAILURE_EN BIT(3)
#define DEBUG_UART_GENI_M_IRQ_EN_M_CMD_CANCEL_EN BIT(4)
#define DEBUG_UART_GENI_M_IRQ_EN_M_CMD_ABORT_EN BIT(5)
#define DEBUG_UART_GENI_M_IRQ_EN_M_TIMESTAMP_EN BIT(6)
#define DEBUG_UART_GENI_M_IRQ_EN_M_RX_IRQ_EN BIT(7)
#define DEBUG_UART_GENI_M_IRQ_EN_M_GP_SYNC_IRQ_0_EN BIT(8)
#define DEBUG_UART_GENI_M_IRQ_EN_M_GP_IRQ_0_EN BIT(9)
#define DEBUG_UART_GENI_M_IRQ_EN_M_GP_IRQ_1_EN BIT(10)
#define DEBUG_UART_GENI_M_IRQ_EN_M_GP_IRQ_2_EN BIT(11)
#define DEBUG_UART_GENI_M_IRQ_EN_M_GP_IRQ_3_EN BIT(12)
#define DEBUG_UART_GENI_M_IRQ_EN_M_GP_IRQ_4_EN BIT(13)
#define DEBUG_UART_GENI_M_IRQ_EN_M_GP_IRQ_5_EN BIT(14)
#define DEBUG_UART_GENI_M_IRQ_EN_M_TX_FIFO_NOT_EMPTY_EN BIT(21)
#define DEBUG_UART_GENI_M_IRQ_EN_M_IO_DATA_DEASSERT_EN BIT(22)
#define DEBUG_UART_GENI_M_IRQ_EN_M_IO_DATA_ASSERT_EN BIT(23)
#define DEBUG_UART_GENI_M_IRQ_EN_M_RX_FIFO_RD_ERR_EN BIT(24)
#define DEBUG_UART_GENI_M_IRQ_EN_M_RX_FIFO_WR_ERR_EN BIT(25)
#define DEBUG_UART_GENI_M_IRQ_EN_M_RX_FIFO_WATERMARK_EN BIT(26)
#define DEBUG_UART_GENI_M_IRQ_EN_M_RX_FIFO_LAST_EN BIT(27)
#define DEBUG_UART_GENI_M_IRQ_EN_M_TX_FIFO_RD_ERR_EN BIT(28)
#define DEBUG_UART_GENI_M_IRQ_EN_M_TX_FIFO_WR_ERR_EN BIT(29)
#define DEBUG_UART_GENI_M_IRQ_EN_M_TX_FIFO_WATERMARK_EN BIT(30)
#define DEBUG_UART_GENI_M_IRQ_EN_M_SEC_IRQ_EN BIT(31)

#define DEBUG_UART_GENI_S_IRQ_EN 0x644
#define DEBUG_UART_GENI_S_IRQ_EN_S_CMD_DONE_EN BIT(0)
#define DEBUG_UART_GENI_S_IRQ_EN_S_CMD_OVERRUN_EN BIT(1)
#define DEBUG_UART_GENI_S_IRQ_EN_S_ILLEGAL_CMD_EN BIT(2)
#define DEBUG_UART_GENI_S_IRQ_EN_S_CMD_FAILURE_EN BIT(3)
#define DEBUG_UART_GENI_S_IRQ_EN_S_CMD_CANCEL_EN BIT(4)
#define DEBUG_UART_GENI_S_IRQ_EN_S_CMD_ABORT_EN BIT(5)
#define DEBUG_UART_GENI_S_IRQ_EN_S_GP_SYNC_IRQ_0_EN BIT(8)
#define DEBUG_UART_GENI_S_IRQ_EN_S_GP_IRQ_0_EN BIT(9)
#define DEBUG_UART_GENI_S_IRQ_EN_S_GP_IRQ_1_EN BIT(10)
#define DEBUG_UART_GENI_S_IRQ_EN_S_GP_IRQ_2_EN BIT(11)
#define DEBUG_UART_GENI_S_IRQ_EN_S_GP_IRQ_3_EN BIT(12)
#define DEBUG_UART_GENI_S_IRQ_EN_S_GP_IRQ_4_EN BIT(13)
#define DEBUG_UART_GENI_S_IRQ_EN_S_GP_IRQ_5_EN BIT(14)
#define DEBUG_UART_GENI_S_IRQ_EN_S_IO_DATA_DEASSERT_EN BIT(22)
#define DEBUG_UART_GENI_S_IRQ_EN_S_IO_DATA_ASSERT_EN BIT(23)
#define DEBUG_UART_GENI_S_IRQ_EN_S_RX_FIFO_RD_ERR_EN BIT(24)
#define DEBUG_UART_GENI_S_IRQ_EN_S_RX_FIFO_WR_ERR_EN BIT(25)
#define DEBUG_UART_GENI_S_IRQ_EN_S_RX_FIFO_WATERMARK_EN BIT(26)
#define DEBUG_UART_GENI_S_IRQ_EN_S_RX_FIFO_LAST_EN BIT(27)

#define DEBUG_UART_GENI_TX_TRANS_LEN 0x270
#define DEBUG_UART_GENI_M_CMD0 0x600
#define DEBUG_UART_GENI_M_CMD0_M_OPCODE_MSK GEN_MSK(31, 27)
#define DEBUG_UART_GENI_M_CMD0_M_OPCODE_SFT 27
#define DEBUG_UART_GENI_M_CMD0_M_PARAMS_MSK GEN_MSK(26, 0)
#define OPCODE_SE_M_UART_START_TX 0x1
#define OPCODE_SE_S_SE_UART_START_RX 0x1

#define DEBUG_UART_GENI_GSI_EVENT_EN 0xe18
#define DEBUG_UART_GENI_DMA_TX_IRQ_CLR 0xc44
#define DEBUG_UART_GENI_DMA_RX_IRQ_CLR 0xd44
#define DEBUG_UART_GENI_SE_IRQ_EN 0xe1c

#define DEBUG_UART_TX_TIMEOUT_US 1000 * 1000 // Max 1ms